{% extends "base.html" %}
{% load static %}

{% block content %}
  <div class="container">


    <h2>{{title}}</h2>
    
    {% if active_timer is not None %}
    <div class="row" style="margin-bottom: 20px; margin-top: 20px;">
      <div class="col-md-5">
	<h4 style="margin-bottom: 0px; margin-top: 3px;">
	  Current Timer - {{active_timer.linked_todo_log.description}}
	  - <span id="current_time"></span>
	</h4>
      </div>
      
      <div id="timer_start_ts" style="display: none;">{{active_timer.started|date:"c"}}</div>

      {% if active_timer.paused is not None %}
      <div id="timer_pause_ts" style="display: none;">{{active_timer.paused|date:"c"}}</div>

      <div class="col-md-1">
	<form action="/resume_timer/{{active_timer.linked_todo_log.unique_id}}">
	  {% csrf_token %}
	  <input type="submit" value="Resume">
	</form>
      </div>
      
      {% else %}

      <div class="col-md-1">
	<form action="/pause_timer/{{active_timer.linked_todo_log.unique_id}}">
	  {% csrf_token %}
	  <input type="submit" value="Pause">
	</form>
      </div>

      {% endif %}
      <div class="col-md-1">
	<form action="/stop_timer/{{active_timer.linked_todo_log.unique_id}}">
	  {% csrf_token %}
	  <input type="submit" value="Stop">
	</form>
      </div>
      
    </div>
    
    {% endif %}
        


{% for todo,timer in todo_logs_and_timers %}
    <div class="row form-group" style="margin-bottom: 5px;">
      <form action="/update_todo_log/{{todo.instance.unique_id}}" method="post" style="display: inline;">
        {% csrf_token %}
        {{ todo.completion }}
        <span style="font-weight:bold;">{{ todo.description }}</span> - {{ todo.duration }}m %{{ todo.tag }} 
        <span style="display: none;">{{ todo.date }}</span>
        
        <input type="submit" value="Update">
      </form>
      <form action="/delete_todo_log/{{todo.instance.unique_id}}" method="POST" style="display: inline;">
        {% csrf_token %}
        <input type="submit" value="Delete">
      </form>
      
      {% if timer is None %}
      <form action="/start_timer/{{todo.instance.unique_id}}" method="POST" style="display: inline;">
	{% csrf_token %}
	<input type="submit" value="Start Timer">
      </form>
      {% endif %}
      
    </div>
{% endfor %}



<h3>New Todo Log Entry: </h3>
<form action="/new_todo_log/" method="post">
  {% csrf_token %}
  {{ form.completion }}
  <label for="id_description">Description: </label> {{ form.description }}
  <label for="id_duration">Duration</label> {{ form.duration }}m
  <label for="id_tag">Tag:</label> %{{ form.tag }}
  <span style="display: none;">{{ form.date }}</span>
  <input type="submit" value="Add Todo Log">
</form>


<h2>
Stats:
</h2>
{% if streak >= 2 %}
<h4>Streak: {{streak}} days!</h4>
{% elif streak == 1 %}
<h4>Streak: 1 day</h4>
{% else %}
<h4>Streak: 0 days :(</h4>
{% endif %}
<div>
    <span style="font-weight:bold;">{{percent_tasks}}% of tasks complete.</span>
</div>
<div>
    <span style="font-weight:bold;">{{percent_time}}% of time complete.</span>
</div>
<div>
  <span style="font-weight:bold;">This day's time:</span> {{completed_time.0}}hr{{completed_time.1}}m
</div>
<div>
    <span style="font-weight:bold;">Last 7 day's time:</span> {{completed_week_time.0}}hr{{completed_week_time.1}}m <span style="font-weight:bold;">Avg:</span> {{avg_week_time.0}}hr{{avg_week_time.1}}m
</div>
<div>
<span style="font-weight:bold;">Last month's time:</span> {{completed_month_time.0}}hr{{completed_month_time.1}}m <span style="font-weight:bold;">Avg:</span> {{avg_month_time.0}}hr{{avg_month_time.1}}m
</div>
<div>
    <span style="font-weight:bold;">Total time:</span> {{total_time.0}}hr{{total_time.1}}m <span style="font-weight:bold;">Avg:</span> {{avg_total_time.0}}hr{{avg_total_time.1}}m
</div>

<div class="row">
  {% for tagset in tags %}
  <div class="col-md-6">
  <h3>
    {{tagset.0}}:
  </h3>
      <ul>
        {% for tag in tagset.1 %}
            <li>{{tag.1}} {{tag.0}}(s), {{tag.2.0}}hr{{tag.2.1}}m </li>
        {% endfor %}
      </ul></div>
  {% endfor %}
</div>
  </div>

  {% if active_timer is not None %}
  <script type="text/javascript">

    
    (function() {

	const get_hr_min = function(seconds) {

	    // say seconds is 365

	    // mins = 60
	    
	    const mins = seconds/60;
	    const rem_secs = seconds%60
	    
	    const hours = mins/60;
	    const rem_mins = mins%60;

	    return [Math.trunc(hours),Math.trunc(rem_mins),Math.trunc(rem_secs)];
	}
	
	let start_ts = new Date($("#timer_start_ts").text());

	const updateTimer = function(ms) {
	    
	    const [hr,min,sec] = get_hr_min(ms/1000);
	    $("#current_time").text(
		(hr.toString().padStart(2, '0') + ':' + 
		 min.toString().padStart(2, '0') + ':' + 
		 sec.toString().padStart(2, '0'))	     
	    );
	    
	}

	const is_paused = $("#timer_pause_ts").length === 1;

	if(is_paused) {
	    const pause_ts = new Date($("#timer_pause_ts").text());
	    const ms = pause_ts - start_ts;

	    updateTimer(ms);
	    
	} else {

	    const int_func = function() {
		const now_ts = Date.now();
		const dt = now_ts - start_ts;
		updateTimer(dt);
	    }

	    int_func();
	    setInterval(int_func, 1000);
	}
    })();
  </script>
  {% endif %}

{% endblock %}
